name: Deploy to ECS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - release
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
  ECS_SERVICE: ${{ secrets.ECS_SERVICE }}
  ECS_TASK_FAMILY: ${{ secrets.ECS_TASK_FAMILY }}
  ECS_CONTAINER_NAME: ${{ secrets.ECS_CONTAINER_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build application
        run: ./gradlew bootJar -x test

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Log in to ECR
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          aws ecr-public get-login-password --region ap-northeast-2 | \
            docker login --username AWS --password-stdin 136399769945.dkr.ecr.ap-northeast-2.amazonaws.com

      - name: Set image metadata
        run: |
          IMAGE_TAG="${GITHUB_SHA}"
          IMAGE_URI="136399769945.dkr.ecr.ap-northeast-2.amazonaws.com/${{ env.ECR_REPOSITORY }}:${IMAGE_TAG}"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> "${GITHUB_ENV}"
          echo "IMAGE_URI=${IMAGE_URI}" >> "${GITHUB_ENV}"

      - name: Build Docker image
        run: docker build -t 136399769945.dkr.ecr.ap-northeast-2.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} .

      - name: Push Docker image
        run: docker push 136399769945.dkr.ecr.ap-northeast-2.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

      - name: Update ECS service
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          ECS_CLUSTER: ${{ env.ECS_CLUSTER }}
          ECS_SERVICE: ${{ env.ECS_SERVICE }}
          ECS_TASK_FAMILY: ${{ env.ECS_TASK_FAMILY }}
          ECS_CONTAINER_NAME: ${{ env.ECS_CONTAINER_NAME }}
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

          TASK_DEF_JSON=$(aws ecs describe-task-definition --task-definition "${ECS_TASK_FAMILY}")
          UPDATED_TASK_DEF=$(echo "${TASK_DEF_JSON}" | jq \
            --arg IMAGE "${IMAGE_URI}" \
            --arg NAME "${ECS_CONTAINER_NAME}" \
            '.taskDefinition
            | .containerDefinitions |= map(if .name == $NAME then .image = $IMAGE else . end)
            | {
                family: .family,
                taskRoleArn: .taskRoleArn,
                executionRoleArn: .executionRoleArn,
                networkMode: .networkMode,
                containerDefinitions: .containerDefinitions,
                volumes: .volumes,
                placementConstraints: .placementConstraints,
                requiresCompatibilities: .requiresCompatibilities,
                cpu: .cpu,
                memory: .memory,
                runtimePlatform: .runtimePlatform
              }')

          echo "${UPDATED_TASK_DEF}" > new-task-def.json
          REVISION_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_SERVICE}" \
            --task-definition "${REVISION_ARN}" \
            --force-new-deployment
